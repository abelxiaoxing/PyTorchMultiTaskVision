# PyTorchMultiTaskVision 项目文档

## 项目概述

**PyTorchMultiTaskVision** 是一个基于PyTorch的深度学习图像分类框架，专注于多任务视觉处理。该项目提供完整的训练、评估和模型管理功能，支持分布式训练和多种神经网络架构。

### 基本信息
- **项目类型**: 机器学习库 (Library)
- **项目状态**: Brownfield (现有项目)
- **创建时间**: 2024年
- **技术栈**: Python 3.12+, PyTorch 2.9.1+
- **主要功能**: 图像分类、目标检测、模型训练

## 项目架构

### 核心组件

#### 1. 训练引擎 (`engine.py`)
- 分布式训练支持
- EMA模型权重平均
- 混合精度训练
- 性能指标监控

#### 2. 数据加载 (`datasets.py`)
- 自动数据集分割
- 数据增强策略
- 支持自定义数据集格式

#### 3. 模型管理 (`nets/`)
- 预训练模型支持
- 自定义网络架构
- 模型转换功能

#### 4. 训练模块 (`train_cls/`, `train_det/`)
- 分类训练 (`train_cls.py`)
- 目标检测训练
- 多种训练模式支持

#### 5. 工具函数 (`utils/`)
- 回调函数管理
- 数据加载器
- 性能指标计算
- 可视化工具

### 技术架构

```
PyTorchMultiTaskVision/
├── 训练引擎层 (engine.py)
│   ├── 训练循环管理
│   ├── 评估功能
│   └── 性能监控
├── 数据管理层 (datasets.py)
│   ├── 数据集加载
│   ├── 数据预处理
│   └── 数据增强
├── 模型层 (nets/)
│   ├── 预训练模型
│   ├── 自定义架构
│   └── 模型转换
├── 训练模块层 (train_cls/, train_det/)
│   ├── 参数配置
│   ├── 训练流程
│   └── 模型保存
└── 工具层 (utils/)
    ├── 工具函数
    ├── 回调管理
    └── 可视化
```

## 功能特性

### 核心功能

1. **图像分类训练**
   - 支持多种神经网络架构
   - 分布式训练支持
   - 自动模型保存和恢复

2. **目标检测支持**
   - YOLO架构集成
   - COCO数据集格式支持
   - 检测性能评估

3. **模型管理**
   - 预训练模型加载
   - 模型转换 (ONNX, TRT)
   - 权重管理

4. **训练优化**
   - 学习率调度
   - 梯度裁剪
   - 混合精度训练

### 高级特性

- **多GPU训练**: 支持分布式数据并行
- **模型EMA**: 指数移动平均权重
- **数据增强**: MixUp, CutMix等策略
- **可视化**: TensorBoard, Weights & Biases集成

## 快速开始

### 安装依赖
```bash
pip install -r requirements.txt
```

### 训练分类模型
```bash
python train_cls.py --data-path /path/to/dataset --model convnextv2_tiny
```

### 评估模型
```bash
python train_cls.py --mode eval --resume /path/to/model.pth
```

## 配置说明

### 训练参数
- `--batch-size`: 批处理大小
- `--epochs`: 训练轮数
- `--lr`: 学习率
- `--model`: 模型架构选择

### 数据参数
- `--data-path`: 数据集路径
- `--input-size`: 输入图像尺寸
- `--mixup`: MixUp增强系数

## 开发指南

### 添加新模型
1. 在 `nets/` 目录下创建模型文件
2. 在 `train_cls.py` 中导入模型
3. 更新模型参数配置

### 自定义数据集
1. 按照标准格式组织数据
2. 在 `datasets.py` 中添加数据集类
3. 配置相应的数据变换

## 性能优化

### 训练优化
- 使用混合精度训练减少内存占用
- 调整批处理大小和梯度累积
- 启用分布式训练加速

### 内存优化
- 使用梯度检查点
- 优化数据加载器配置
- 合理设置模型保存频率

## 故障排除

### 常见问题
1. **内存不足**: 减小批处理大小或使用梯度累积
2. **训练不稳定**: 调整学习率或启用梯度裁剪
3. **模型不收敛**: 检查数据预处理和模型配置

### 调试技巧
- 启用详细日志输出
- 使用TensorBoard监控训练过程
- 检查数据加载器性能

## 版本历史

### 最新更新 (2025-07-30)
- 简化engine和datasets代码结构
- 移除mmdet依赖
- 优化数据划分性能
- 改进模型EMA实现

### 历史版本
- 2024-12-17: 模型转换功能增强
- 2024-11-27: 集群训练支持

---

*本文档由BMAD工作流自动生成，最后更新于2025年11月22日*